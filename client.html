<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JELILIAN - åç«¯APIå®¢æˆ·ç«¯</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #6366f1; margin-bottom: 10px; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .section h3 { color: #1f2937; margin-bottom: 15px; }
        .input-group { margin: 15px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; }
        .input-group textarea { height: 100px; resize: vertical; }
        .btn { background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 5px; transition: background 0.3s; }
        .btn:hover { background: #4f46e5; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover { background: #d97706; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .result { margin-top: 20px; padding: 15px; border-radius: 6px; }
        .success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
        .warning { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .code { background: #f3f4f6; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; overflow-x: auto; margin: 10px 0; white-space: pre-wrap; }
        .chat-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chat-messages { height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f8fafc; }
        .message { margin-bottom: 15px; }
        .user-message { text-align: right; }
        .user-message .content { background: #6366f1; color: white; padding: 10px 15px; border-radius: 18px 18px 4px 18px; display: inline-block; max-width: 80%; }
        .ai-message .content { background: white; color: #1f2937; padding: 10px 15px; border-radius: 18px 18px 18px 4px; display: inline-block; max-width: 80%; border: 1px solid #e5e7eb; }
        .message-meta { font-size: 11px; color: #6b7280; margin-top: 5px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb; }
        .stat-number { font-size: 1.5rem; font-weight: bold; color: #6366f1; }
        .stat-label { font-size: 0.9rem; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– JELILIAN åç«¯APIå®¢æˆ·ç«¯</h1>
            <p>é€šè¿‡åç«¯æœåŠ¡å™¨è°ƒç”¨AI APIï¼Œæ— CORSé™åˆ¶</p>
            <div id="serverStatus" class="result info">æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</div>
        </div>
        
        <div class="section">
            <h3>ğŸ”§ APIé…ç½®</h3>
            <div class="input-group">
                <label>é€‰æ‹©AIæœåŠ¡å•†</label>
                <select id="provider">
                    <option value="qwen">é˜¿é‡Œåƒé—® (æ¨è)</option>
                    <option value="openai">OpenAI GPT</option>
                </select>
            </div>
            <div class="input-group">
                <label>APIå¯†é’¥</label>
                <input type="password" id="apiKey" placeholder="è¾“å…¥APIå¯†é’¥">
            </div>
            <div class="input-group">
                <label>æ¨¡å‹é€‰æ‹© (å¯é€‰)</label>
                <select id="model">
                    <option value="">é»˜è®¤æ¨¡å‹</option>
                    <option value="qwen-turbo">qwen-turbo</option>
                    <option value="qwen-plus">qwen-plus</option>
                    <option value="qwen-max">qwen-max</option>
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                    <option value="gpt-4">gpt-4</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button class="btn btn-secondary" onclick="getProviders()">è·å–æ”¯æŒçš„æœåŠ¡å•†</button>
            <div id="configResult"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ’¬ AIå¯¹è¯æµ‹è¯•</h3>
            <div class="chat-container">
                <div>
                    <div class="input-group">
                        <label>æ¶ˆæ¯å†…å®¹</label>
                        <textarea id="message" placeholder="è¾“å…¥æ‚¨æƒ³è¦å‘é€çš„æ¶ˆæ¯...">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ï¼Œä»¥åŠä½ èƒ½å¸®æˆ‘åšä»€ä¹ˆï¼Ÿ</textarea>
                    </div>
                    <button class="btn" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
                    <button class="btn btn-warning" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
                    
                    <div class="stats" id="chatStats">
                        <div class="stat-card">
                            <div class="stat-number" id="messageCount">0</div>
                            <div class="stat-label">æ¶ˆæ¯æ•°é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avgResponseTime">0ms</div>
                            <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTokens">0</div>
                            <div class="stat-label">æ€»Tokenä½¿ç”¨</div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label><strong>å¯¹è¯å†å²</strong></label>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <div class="content">æ‚¨å¥½ï¼æˆ‘æ˜¯JELILIAN AIåŠ©æ‰‹ã€‚è¯·é…ç½®APIå¯†é’¥åå¼€å§‹å¯¹è¯ã€‚</div>
                            <div class="message-meta">ç³»ç»Ÿæ¶ˆæ¯</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ” æ‰¹é‡å¯¹æ¯”æµ‹è¯•</h3>
            <div class="input-group">
                <label>å¯¹æ¯”æ¶ˆæ¯</label>
                <textarea id="compareMessage" placeholder="è¾“å…¥è¦å¯¹æ¯”çš„æ¶ˆæ¯...">è¯·ç”¨ä¸€å¥è¯ä»‹ç»äººå·¥æ™ºèƒ½</textarea>
            </div>
            <div class="input-group">
                <label>OpenAI APIå¯†é’¥ (ç”¨äºå¯¹æ¯”)</label>
                <input type="password" id="openaiKey" placeholder="è¾“å…¥OpenAI APIå¯†é’¥ (å¯é€‰)">
            </div>
            <button class="btn btn-warning" onclick="compareAIs()">å¯¹æ¯”ä¸åŒAIå“åº”</button>
            <div id="compareResult"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“Š æœåŠ¡å™¨ä¿¡æ¯</h3>
            <button class="btn btn-secondary" onclick="getServerInfo()">è·å–æœåŠ¡å™¨ä¿¡æ¯</button>
            <div id="serverInfo"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let messageCount = 0;
        let totalResponseTime = 0;
        let totalTokens = 0;
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
        });
        
        async function checkServerStatus() {
            const statusDiv = document.getElementById('serverStatus');
            
            try {
                const response = await fetch(`${API_BASE}/providers`);
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="result success">âœ… åç«¯æœåŠ¡å™¨è¿è¡Œæ­£å¸¸</div>';
                } else {
                    throw new Error('æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="result error">
                        âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨<br>
                        <strong>è¯·ç¡®ä¿:</strong><br>
                        1. å·²å®‰è£…ä¾èµ–: <code>npm install</code><br>
                        2. å·²å¯åŠ¨æœåŠ¡å™¨: <code>npm start</code><br>
                        3. æœåŠ¡å™¨è¿è¡Œåœ¨: <code>http://localhost:3000</code>
                    </div>
                `;
            }
        }
        
        async function testConnection() {
            const provider = document.getElementById('provider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('configResult');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: provider,
                        apiKey: apiKey
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼<br>
                            <strong>æœåŠ¡å•†:</strong> ${data.provider}<br>
                            <strong>å“åº”æ—¶é—´:</strong> ${data.responseTime}ms<br>
                            <strong>æµ‹è¯•å“åº”:</strong> ${data.testResponse}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ è¿æ¥æµ‹è¯•å¤±è´¥<br>
                            <strong>é”™è¯¯:</strong> ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ è¯·æ±‚å¤±è´¥: ${error.message}<br>
                        è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
                    </div>
                `;
            }
        }
        
        async function sendMessage() {
            const provider = document.getElementById('provider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const message = document.getElementById('message').value.trim();
            const model = document.getElementById('model').value;
            
            if (!apiKey || !message) {
                alert('è¯·è¾“å…¥APIå¯†é’¥å’Œæ¶ˆæ¯å†…å®¹');
                return;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©
            addMessageToChat(message, 'user');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingId = addMessageToChat('æ­£åœ¨æ€è€ƒ...', 'ai', true);
            
            try {
                const startTime = Date.now();
                
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        provider: provider,
                        apiKey: apiKey,
                        options: {
                            model: model || undefined,
                            maxTokens: 1500,
                            temperature: 0.8
                        }
                    })
                });
                
                const data = await response.json();
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                removeMessage(loadingId);
                
                if (data.success) {
                    // æ·»åŠ AIå“åº”
                    addMessageToChat(data.text, 'ai', false, {
                        responseTime: data.responseTime,
                        tokens: data.tokens,
                        model: data.model
                    });
                    
                    // æ›´æ–°ç»Ÿè®¡
                    updateStats(data.responseTime, data.tokens);
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('message').value = '';
                    
                } else {
                    addMessageToChat(`âŒ é”™è¯¯: ${data.error}`, 'ai');
                }
                
            } catch (error) {
                removeMessage(loadingId);
                addMessageToChat(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'ai');
            }
        }
        
        function addMessageToChat(content, type, isLoading = false, meta = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.id = messageId;
            
            let metaInfo = '';
            if (meta) {
                metaInfo = `<div class="message-meta">
                    å“åº”æ—¶é—´: ${meta.responseTime}ms | 
                    Token: ${meta.tokens} | 
                    æ¨¡å‹: ${meta.model}
                </div>`;
            } else if (type === 'user') {
                metaInfo = `<div class="message-meta">${new Date().toLocaleTimeString()}</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="content">
                    ${isLoading ? '<span class="loading"></span> ' : ''}${content}
                </div>
                ${metaInfo}
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }
        
        function removeMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
        }
        
        function updateStats(responseTime, tokens) {
            messageCount++;
            totalResponseTime += responseTime;
            totalTokens += tokens;
            
            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('avgResponseTime').textContent = 
                Math.round(totalResponseTime / messageCount) + 'ms';
            document.getElementById('totalTokens').textContent = totalTokens;
        }
        
        function clearChat() {
            document.getElementById('chatMessages').innerHTML = `
                <div class="message ai-message">
                    <div class="content">å¯¹è¯å·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯ã€‚</div>
                    <div class="message-meta">ç³»ç»Ÿæ¶ˆæ¯</div>
                </div>
            `;
            
            // é‡ç½®ç»Ÿè®¡
            messageCount = 0;
            totalResponseTime = 0;
            totalTokens = 0;
            updateStats(0, 0);
        }
        
        async function getProviders() {
            const resultDiv = document.getElementById('configResult');
            
            try {
                const response = await fetch(`${API_BASE}/providers`);
                const data = await response.json();
                
                if (data.success) {
                    const providersList = data.providers.map(p => 
                        `â€¢ <strong>${p.name}</strong>: ${p.description}`
                    ).join('<br>');
                    
                    resultDiv.innerHTML = `
                        <div class="result info">
                            <strong>ğŸ“‹ æ”¯æŒçš„AIæœåŠ¡å•†:</strong><br><br>
                            ${providersList}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ è·å–æœåŠ¡å•†ä¿¡æ¯å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function compareAIs() {
            const message = document.getElementById('compareMessage').value.trim();
            const qwenKey = document.getElementById('apiKey').value.trim();
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const resultDiv = document.getElementById('compareResult');
            
            if (!message) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥å¯¹æ¯”æ¶ˆæ¯</div>';
                return;
            }
            
            const apiKeys = {};
            const providers = [];
            
            if (qwenKey) {
                apiKeys.qwen = qwenKey;
                providers.push('qwen');
            }
            
            if (openaiKey) {
                apiKeys.openai = openaiKey;
                providers.push('openai');
            }
            
            if (providers.length === 0) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªAPIå¯†é’¥</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ æ­£åœ¨å¯¹æ¯”ä¸åŒAIçš„å“åº”...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/compare`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        providers: providers,
                        apiKeys: apiKeys
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let compareHtml = `<div class="result success">
                        <strong>ğŸ” AIå¯¹æ¯”ç»“æœ:</strong><br>
                        <strong>é—®é¢˜:</strong> ${data.message}<br><br>
                    `;
                    
                    Object.entries(data.results).forEach(([provider, result]) => {
                        const providerName = provider === 'qwen' ? 'é˜¿é‡Œåƒé—®' : 'OpenAI';
                        
                        if (result.success) {
                            compareHtml += `
                                <div style="margin: 15px 0; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                                    <strong>${providerName}:</strong><br>
                                    <div style="margin: 10px 0; padding: 10px; background: #f8fafc; border-radius: 6px;">
                                        ${result.text}
                                    </div>
                                    <small>å“åº”æ—¶é—´: ${result.responseTime}ms | Token: ${result.tokens}</small>
                                </div>
                            `;
                        } else {
                            compareHtml += `
                                <div style="margin: 15px 0; padding: 15px; border: 1px solid #ef4444; border-radius: 8px; background: #fee2e2;">
                                    <strong>${providerName}:</strong> âŒ ${result.error}
                                </div>
                            `;
                        }
                    });
                    
                    compareHtml += '</div>';
                    resultDiv.innerHTML = compareHtml;
                } else {
                    resultDiv.innerHTML = `<div class="result error">âŒ å¯¹æ¯”å¤±è´¥: ${data.error}</div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ å¯¹æ¯”è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function getServerInfo() {
            const resultDiv = document.getElementById('serverInfo');
            
            try {
                const response = await fetch(`${API_BASE}/providers`);
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="result info">
                        <strong>ğŸ–¥ï¸ æœåŠ¡å™¨ä¿¡æ¯:</strong><br><br>
                        <strong>APIåœ°å€:</strong> ${API_BASE}<br>
                        <strong>çŠ¶æ€:</strong> è¿è¡Œæ­£å¸¸<br>
                        <strong>æ”¯æŒçš„æœåŠ¡å•†:</strong> ${data.providers.length}ä¸ª<br>
                        <strong>å½“å‰æ—¶é—´:</strong> ${new Date().toLocaleString()}<br><br>
                        
                        <strong>ğŸ“¡ å¯ç”¨ç«¯ç‚¹:</strong><br>
                        â€¢ POST /api/chat - AIå¯¹è¯<br>
                        â€¢ POST /api/test - è¿æ¥æµ‹è¯•<br>
                        â€¢ GET /api/providers - è·å–æœåŠ¡å•†<br>
                        â€¢ POST /api/compare - æ‰¹é‡å¯¹æ¯”
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ è·å–æœåŠ¡å™¨ä¿¡æ¯å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // å¿«æ·é”®æ”¯æŒ
        document.getElementById('message').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>