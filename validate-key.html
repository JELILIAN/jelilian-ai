<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå¯†é’¥éªŒè¯å·¥å…·</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #6366f1; margin-bottom: 10px; }
        .input-group { margin: 15px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; }
        .input-group input, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; }
        .btn { background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 5px; }
        .btn:hover { background: #4f46e5; }
        .result { margin-top: 20px; padding: 15px; border-radius: 6px; }
        .success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .warning { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
        .code { background: #f3f4f6; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .check-item { margin: 10px 0; padding: 10px; border-radius: 6px; }
        .check-pass { background: #d1fae5; border-left: 4px solid #10b981; }
        .check-fail { background: #fee2e2; border-left: 4px solid #ef4444; }
        .check-warn { background: #fef3c7; border-left: 4px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”‘ APIå¯†é’¥éªŒè¯å·¥å…·</h1>
            <p>æ£€æŸ¥å’Œä¿®å¤APIå¯†é’¥æ ¼å¼é—®é¢˜</p>
        </div>
        
        <div class="input-group">
            <label>è¾“å…¥APIå¯†é’¥:</label>
            <textarea id="apiKey" rows="3" placeholder="ç²˜è´´æ‚¨çš„APIå¯†é’¥..."></textarea>
        </div>
        
        <button class="btn" onclick="validateKey()">éªŒè¯å¯†é’¥</button>
        <button class="btn" onclick="cleanKey()">æ¸…ç†å¯†é’¥</button>
        <button class="btn" onclick="testKey()">æµ‹è¯•è¿æ¥</button>
        
        <div id="result"></div>
        
        <div class="result info">
            <strong>ğŸ’¡ å¸¸è§é—®é¢˜:</strong><br><br>
            <strong>1. éæ³•å­—ç¬¦é”™è¯¯</strong><br>
            â€¢ å¯†é’¥ä¸­åŒ…å«ç©ºæ ¼ã€æ¢è¡Œç¬¦æˆ–ç‰¹æ®Šå­—ç¬¦<br>
            â€¢ è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨"æ¸…ç†å¯†é’¥"åŠŸèƒ½<br><br>
            
            <strong>2. æ ¼å¼ä¸æ­£ç¡®</strong><br>
            â€¢ é˜¿é‡Œåƒé—®å¯†é’¥åº”è¯¥ä»¥"sk-"å¼€å¤´<br>
            â€¢ é•¿åº¦é€šå¸¸åœ¨50-100ä¸ªå­—ç¬¦ä¹‹é—´<br><br>
            
            <strong>3. å¤åˆ¶ç²˜è´´é—®é¢˜</strong><br>
            â€¢ å¯èƒ½å¤åˆ¶äº†å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œ<br>
            â€¢ å»ºè®®é‡æ–°å¤åˆ¶å®Œæ•´çš„å¯†é’¥
        </div>
    </div>

    <script>
        function validateKey() {
            const apiKey = document.getElementById('apiKey').value;
            const resultDiv = document.getElementById('result');
            
            if (!apiKey.trim()) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥</div>';
                return;
            }
            
            const checks = [];
            let isValid = true;
            
            // æ£€æŸ¥1: åŸºæœ¬æ ¼å¼
            if (apiKey.startsWith('sk-')) {
                checks.push({
                    name: 'æ ¼å¼æ£€æŸ¥',
                    status: 'pass',
                    message: 'âœ… å¯†é’¥ä»¥"sk-"å¼€å¤´ï¼Œæ ¼å¼æ­£ç¡®'
                });
            } else {
                checks.push({
                    name: 'æ ¼å¼æ£€æŸ¥',
                    status: 'fail',
                    message: 'âŒ å¯†é’¥åº”è¯¥ä»¥"sk-"å¼€å¤´'
                });
                isValid = false;
            }
            
            // æ£€æŸ¥2: é•¿åº¦
            const length = apiKey.trim().length;
            if (length >= 20 && length <= 200) {
                checks.push({
                    name: 'é•¿åº¦æ£€æŸ¥',
                    status: 'pass',
                    message: `âœ… å¯†é’¥é•¿åº¦æ­£å¸¸ (${length}ä¸ªå­—ç¬¦)`
                });
            } else {
                checks.push({
                    name: 'é•¿åº¦æ£€æŸ¥',
                    status: 'fail',
                    message: `âŒ å¯†é’¥é•¿åº¦å¼‚å¸¸ (${length}ä¸ªå­—ç¬¦)ï¼Œæ­£å¸¸èŒƒå›´20-200`
                });
                isValid = false;
            }
            
            // æ£€æŸ¥3: éæ³•å­—ç¬¦
            const invalidChars = apiKey.match(/[^a-zA-Z0-9\-_]/g);
            if (!invalidChars) {
                checks.push({
                    name: 'å­—ç¬¦æ£€æŸ¥',
                    status: 'pass',
                    message: 'âœ… å¯†é’¥ä¸åŒ…å«éæ³•å­—ç¬¦'
                });
            } else {
                const uniqueInvalidChars = [...new Set(invalidChars)];
                checks.push({
                    name: 'å­—ç¬¦æ£€æŸ¥',
                    status: 'fail',
                    message: `âŒ å‘ç°éæ³•å­—ç¬¦: ${uniqueInvalidChars.map(c => `"${c}"`).join(', ')}`
                });
                isValid = false;
            }
            
            // æ£€æŸ¥4: ç©ºæ ¼å’Œæ¢è¡Œ
            const hasWhitespace = /\s/.test(apiKey);
            if (!hasWhitespace) {
                checks.push({
                    name: 'ç©ºæ ¼æ£€æŸ¥',
                    status: 'pass',
                    message: 'âœ… å¯†é’¥ä¸åŒ…å«ç©ºæ ¼æˆ–æ¢è¡Œç¬¦'
                });
            } else {
                checks.push({
                    name: 'ç©ºæ ¼æ£€æŸ¥',
                    status: 'warn',
                    message: 'âš ï¸ å¯†é’¥åŒ…å«ç©ºæ ¼æˆ–æ¢è¡Œç¬¦ï¼Œå»ºè®®æ¸…ç†'
                });
            }
            
            // ç”Ÿæˆç»“æœ
            let resultHtml = `<div class="result ${isValid ? 'success' : 'error'}">
                <strong>${isValid ? 'âœ… å¯†é’¥éªŒè¯é€šè¿‡' : 'âŒ å¯†é’¥éªŒè¯å¤±è´¥'}</strong><br><br>
            `;
            
            checks.forEach(check => {
                const className = check.status === 'pass' ? 'check-pass' : 
                                check.status === 'fail' ? 'check-fail' : 'check-warn';
                resultHtml += `<div class="check-item ${className}">
                    <strong>${check.name}:</strong> ${check.message}
                </div>`;
            });
            
            if (!isValid) {
                resultHtml += `<br><strong>ğŸ”§ å»ºè®®:</strong><br>
                1. ç‚¹å‡»"æ¸…ç†å¯†é’¥"æŒ‰é’®è‡ªåŠ¨ä¿®å¤<br>
                2. é‡æ–°ä»æ§åˆ¶å°å¤åˆ¶å®Œæ•´çš„APIå¯†é’¥<br>
                3. ç¡®ä¿å¯†é’¥æ²¡æœ‰è¢«æˆªæ–­æˆ–ä¿®æ”¹`;
            }
            
            resultHtml += '</div>';
            resultDiv.innerHTML = resultHtml;
        }
        
        function cleanKey() {
            const apiKeyInput = document.getElementById('apiKey');
            const originalKey = apiKeyInput.value;
            
            if (!originalKey.trim()) {
                document.getElementById('result').innerHTML = '<div class="result error">âŒ è¯·å…ˆè¾“å…¥APIå¯†é’¥</div>';
                return;
            }
            
            // æ¸…ç†æ­¥éª¤
            let cleanedKey = originalKey;
            
            // 1. ç§»é™¤å‰åç©ºæ ¼å’Œæ¢è¡Œç¬¦
            cleanedKey = cleanedKey.trim().replace(/\s+/g, '');
            
            // 2. ç§»é™¤å…¶ä»–éæ³•å­—ç¬¦ï¼ˆåªä¿ç•™å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿ï¼‰
            cleanedKey = cleanedKey.replace(/[^a-zA-Z0-9\-_]/g, '');
            
            // æ›´æ–°è¾“å…¥æ¡†
            apiKeyInput.value = cleanedKey;
            
            // æ˜¾ç¤ºæ¸…ç†ç»“æœ
            const changes = [];
            if (originalKey !== cleanedKey) {
                if (originalKey.length !== cleanedKey.length) {
                    changes.push(`é•¿åº¦ä» ${originalKey.length} å˜ä¸º ${cleanedKey.length}`);
                }
                if (/\s/.test(originalKey)) {
                    changes.push('ç§»é™¤äº†ç©ºæ ¼å’Œæ¢è¡Œç¬¦');
                }
                if (/[^a-zA-Z0-9\-_\s]/.test(originalKey)) {
                    changes.push('ç§»é™¤äº†ç‰¹æ®Šå­—ç¬¦');
                }
                
                document.getElementById('result').innerHTML = `
                    <div class="result success">
                        âœ… å¯†é’¥æ¸…ç†å®Œæˆ<br><br>
                        <strong>æ¸…ç†å†…å®¹:</strong><br>
                        â€¢ ${changes.join('<br>â€¢ ')}<br><br>
                        <strong>æ¸…ç†åçš„å¯†é’¥:</strong><br>
                        <div class="code">${cleanedKey}</div>
                    </div>
                `;
            } else {
                document.getElementById('result').innerHTML = '<div class="result info">â„¹ï¸ å¯†é’¥å·²ç»æ˜¯å¹²å‡€çš„ï¼Œæ— éœ€æ¸…ç†</div>';
            }
        }
        
        async function testKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ æ­£åœ¨æµ‹è¯•APIè¿æ¥...</div>';
            
            try {
                const response = await fetch('http://localhost:3000/api/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: 'qwen',
                        apiKey: apiKey
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼<br><br>
                            <strong>æœåŠ¡å•†:</strong> ${data.provider}<br>
                            <strong>å“åº”æ—¶é—´:</strong> ${data.responseTime}ms<br>
                            <strong>å¯†é’¥çŠ¶æ€:</strong> æœ‰æ•ˆ<br>
                            <strong>æµ‹è¯•å“åº”:</strong><br>
                            <div class="code">${data.testResponse}</div>
                        </div>
                    `;
                } else {
                    let errorHtml = `
                        <div class="result error">
                            âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥<br><br>
                            <strong>é”™è¯¯ä¿¡æ¯:</strong> ${data.error}<br>
                    `;
                    
                    if (data.debug) {
                        errorHtml += `<br><strong>è°ƒè¯•ä¿¡æ¯:</strong><br>`;
                        Object.entries(data.debug).forEach(([key, value]) => {
                            errorHtml += `â€¢ ${key}: ${value}<br>`;
                        });
                    }
                    
                    errorHtml += '</div>';
                    resultDiv.innerHTML = errorHtml;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ æµ‹è¯•è¯·æ±‚å¤±è´¥: ${error.message}<br><br>
                        <strong>å¯èƒ½åŸå› :</strong><br>
                        â€¢ åç«¯æœåŠ¡å™¨æœªå¯åŠ¨<br>
                        â€¢ ç½‘ç»œè¿æ¥é—®é¢˜<br>
                        â€¢ æœåŠ¡å™¨åœ°å€ä¸æ­£ç¡®
                    </div>
                `;
            }
        }
        
        // è‡ªåŠ¨æ£€æµ‹ç²˜è´´çš„å†…å®¹
        document.getElementById('apiKey').addEventListener('paste', function() {
            setTimeout(() => {
                validateKey();
            }, 100);
        });
    </script>
</body>
</html>