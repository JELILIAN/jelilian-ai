<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JELILIAN - AIåŠ©æ‰‹</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #6366f1; margin-bottom: 10px; font-size: 2.5rem; }
        .header p { color: #6b7280; font-size: 1.1rem; }
        .section { margin: 30px 0; padding: 25px; border: 1px solid #e0e0e0; border-radius: 12px; background: #fafafa; }
        .section h3 { color: #1f2937; margin-bottom: 20px; font-size: 1.3rem; }
        .input-group { margin: 20px 0; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
        .input-group input, .input-group textarea, .input-group select { 
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; 
            font-family: inherit; transition: border-color 0.3s; font-size: 16px;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .input-group textarea { height: 120px; resize: vertical; }
        .btn { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; 
            padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; 
            margin: 8px; transition: all 0.3s; font-size: 16px; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-secondary { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .result { margin-top: 20px; padding: 20px; border-radius: 10px; }
        .success { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border: 2px solid #10b981; }
        .error { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; border: 2px solid #ef4444; }
        .info { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; border: 2px solid #3b82f6; }
        .warning { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border: 2px solid #f59e0b; }
        .chat-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .chat-messages { 
            height: 450px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 12px; 
            padding: 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); 
        }
        .message { margin-bottom: 20px; }
        .user-message { text-align: right; }
        .user-message .content { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; 
            padding: 12px 18px; border-radius: 20px 20px 6px 20px; display: inline-block; 
            max-width: 80%; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .ai-message .content { 
            background: white; color: #1f2937; padding: 12px 18px; 
            border-radius: 20px 20px 20px 6px; display: inline-block; max-width: 80%; 
            border: 2px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .message-meta { font-size: 12px; color: #6b7280; margin-top: 8px; }
        .loading { 
            display: inline-block; width: 20px; height: 20px; 
            border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; 
            border-radius: 50%; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin: 25px 0; }
        .stat-card { 
            background: linear-gradient(135deg, #f8fafc, #e2e8f0); padding: 20px; 
            border-radius: 12px; text-align: center; border: 2px solid #e5e7eb; 
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-4px); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #6366f1; }
        .stat-label { font-size: 1rem; color: #6b7280; margin-top: 5px; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }
        .feature-card { 
            background: white; padding: 25px; border-radius: 12px; 
            border: 2px solid #e5e7eb; transition: all 0.3s;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .feature-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); 
            border-color: #6366f1;
        }
        .feature-card::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 0; height: 0; border-style: solid;
            border-width: 0 20px 20px 0;
            border-color: transparent #6366f1 transparent transparent;
            opacity: 0; transition: opacity 0.3s;
        }
        .feature-card:hover::after { opacity: 1; }
        .feature-icon { font-size: 2.5rem; margin-bottom: 15px; }
        .feature-title { font-size: 1.2rem; font-weight: bold; color: #1f2937; margin-bottom: 10px; }
        .feature-desc { color: #6b7280; line-height: 1.6; margin-bottom: 10px; }
        .feature-tag { 
            background: #f0f9ff; color: #0369a1; padding: 4px 8px; 
            border-radius: 12px; font-size: 0.8rem; font-weight: 500;
        }
        
        .quick-btn {
            background: #f3f4f6; color: #374151; border: none; padding: 8px 12px;
            border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .quick-btn:hover {
            background: #6366f1; color: white; transform: translateY(-2px);
        }
        
        .input-group label {
            display: block; margin-bottom: 8px; font-weight: 600; color: #374151;
        }
        
        .chat-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0;
        }
        
        @media (max-width: 768px) {
            .chat-container { grid-template-columns: 1fr; }
            .config-section > div:first-child { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-nav">
            <div class="logo">
                <h1>JELILIAN</h1>
                <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">AIåŠ©æ‰‹</span>
            </div>
            <div class="nav-buttons">
                <a href="/payment-system.html" class="nav-btn secondary">ğŸ’ å‡çº§ä¸“ä¸šç‰ˆ</a>
                <a href="/admin-dashboard.html" class="nav-btn secondary">ğŸ“Š ç®¡ç†åå°</a>
                <button class="nav-btn primary" onclick="showHelp()">â“ å¸®åŠ©</button>
            </div>
        </div>
        
        <div class="header">
            <h2 style="text-align: center; color: #1f2937; margin-bottom: 10px;">ğŸš€ å¼€å§‹ä½ çš„AIåˆ›ä½œä¹‹æ—…</h2>
            <p style="text-align: center; color: #6b7280; margin-bottom: 20px;">è¾“å…¥APIå¯†é’¥ï¼Œè§£é”æ— é™åˆ›ä½œå¯èƒ½</p>
            <div id="subscriptionStatus"></div>
        </div>
        
        <div class="features-showcase" style="margin: 30px 0;">
            <h3 style="text-align: center; color: #1f2937; margin-bottom: 25px;">âœ¨ å¼ºå¤§åŠŸèƒ½ä¸€è§ˆ</h3>
            <div class="feature-grid">
                <div class="feature-card" onclick="setQuickPrompt('å¸®æˆ‘åˆ›å»ºä¸€ä¸ªç°ä»£åŒ–çš„ä¼ä¸šå®˜ç½‘')">
                    <div class="feature-icon">ğŸŒ</div>
                    <div class="feature-title">ç½‘ç«™æ„å»º</div>
                    <div class="feature-desc">ä¸€å¥è¯ç”Ÿæˆå®Œæ•´ç½‘ç«™ï¼ŒåŒ…å«å‰ç«¯åç«¯æ•°æ®åº“</div>
                    <div class="feature-tag">ç‚¹å‡»è¯•ç”¨</div>
                </div>
                <div class="feature-card" onclick="setQuickPrompt('å†™ä¸€ä»½ä¸“ä¸šçš„äº§å“è¥é”€æ–‡æ¡ˆ')">
                    <div class="feature-icon">âœï¸</div>
                    <div class="feature-title">å†…å®¹åˆ›ä½œ</div>
                    <div class="feature-desc">AIé©±åŠ¨çš„æ–‡æ¡ˆå†™ä½œã€åšå®¢åˆ›ä½œå’Œè¥é”€å†…å®¹</div>
                    <div class="feature-tag">ç‚¹å‡»è¯•ç”¨</div>
                </div>
                <div class="feature-card" onclick="setQuickPrompt('å¸®æˆ‘å†™ä¸€ä¸ªPythonæ•°æ®åˆ†æè„šæœ¬')">
                    <div class="feature-icon">ğŸ’»</div>
                    <div class="feature-title">ä»£ç ç”Ÿæˆ</div>
                    <div class="feature-desc">æ™ºèƒ½ä»£ç ç”Ÿæˆã€è°ƒè¯•å’Œä¼˜åŒ–ï¼Œæ”¯æŒå¤šè¯­è¨€</div>
                    <div class="feature-tag">ç‚¹å‡»è¯•ç”¨</div>
                </div>
                <div class="feature-card" onclick="setQuickPrompt('åˆ¶ä½œä¸€ä»½å•†ä¸šè®¡åˆ’ä¹¦PPTå¤§çº²')">
                    <div class="feature-icon">ğŸ“Š</div>
                    <div class="feature-title">å•†ä¸šåŠ©æ‰‹</div>
                    <div class="feature-desc">å•†ä¸šè®¡åˆ’ã€æ•°æ®åˆ†æã€æŠ¥å‘Šç”Ÿæˆ</div>
                    <div class="feature-tag">ç‚¹å‡»è¯•ç”¨</div>
                </div>
            </div>
        </div>
        
        <div class="config-section" style="background: #f8fafc; padding: 30px; border-radius: 15px; margin: 30px 0;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <h3 style="color: #1f2937; margin: 0;">âš™ï¸ å¿«é€Ÿé…ç½®</h3>
                <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">2åˆ†é’Ÿè®¾ç½®</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="input-group">
                    <label>ğŸ¤– AIæœåŠ¡å•†</label>
                    <select id="provider" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem;">
                        <option value="qwen">ğŸ‡¨ğŸ‡³ é˜¿é‡Œåƒé—® (æ¨è)</option>
                        <option value="openai">ğŸŒ OpenAI GPT</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ğŸ”‘ APIå¯†é’¥</label>
                    <input type="password" id="apiKey" placeholder="sk-..." style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem;">
                </div>
                <div class="input-group">
                    <label>ğŸ¯ æ¨¡å‹é€‰æ‹©</label>
                    <select id="model" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem;">
                        <option value="">æ™ºèƒ½é€‰æ‹©</option>
                        <option value="qwen-turbo">åƒé—®-å¿«é€Ÿç‰ˆ</option>
                        <option value="qwen-plus">åƒé—®-å¹³è¡¡ç‰ˆ</option>
                        <option value="qwen-max">åƒé—®-æœ€å¼ºç‰ˆ</option>
                        <option value="gpt-3.5-turbo">GPT-3.5</option>
                        <option value="gpt-4">GPT-4</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="testConnection()" style="padding: 12px 24px; font-size: 1rem;">
                    ğŸš€ æµ‹è¯•è¿æ¥
                </button>
                <button class="btn btn-secondary" onclick="getProviders()" style="padding: 12px 24px; font-size: 1rem;">
                    ğŸ“‹ æŸ¥çœ‹æœåŠ¡å•†
                </button>
                <button class="btn btn-warning" onclick="upgradeToPro()" style="padding: 12px 24px; font-size: 1rem;">
                    ğŸ’ å‡çº§ä¸“ä¸šç‰ˆ
                </button>
                <button class="btn" onclick="showAPIHelp()" style="padding: 12px 24px; font-size: 1rem; background: #8b5cf6;">
                    â“ è·å–APIå¯†é’¥
                </button>
            </div>
            <div id="configResult"></div>
        </div>
        
        <div class="chat-section" style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 30px 0;">
            <div class="chat-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 20px; text-align: center;">
                <h3 style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    ğŸ’¬ AIæ™ºèƒ½å¯¹è¯
                    <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">å®æ—¶å“åº”</span>
                </h3>
            </div>
            
            <div class="chat-container">
                <div class="chat-input-area" style="padding: 20px;">
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px;">ğŸ¯ å¿«é€Ÿå¼€å§‹</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="quick-btn" onclick="setQuickPrompt('åˆ›å»ºä¸€ä¸ªé¤å…ç½‘ç«™ï¼ŒåŒ…å«èœå•å’Œé¢„è®¢åŠŸèƒ½')">ğŸ½ï¸ é¤å…ç½‘ç«™</button>
                            <button class="quick-btn" onclick="setQuickPrompt('å†™ä¸€ä»½äº§å“å‘å¸ƒä¼šçš„æ–°é—»ç¨¿')">ğŸ“° æ–°é—»ç¨¿</button>
                            <button class="quick-btn" onclick="setQuickPrompt('åˆ¶ä½œä¸€ä¸ªPythonçˆ¬è™«è„šæœ¬')">ğŸ Pythonä»£ç </button>
                            <button class="quick-btn" onclick="setQuickPrompt('è®¾è®¡ä¸€ä¸ªLogoçš„åˆ›æ„æ–¹æ¡ˆ')">ğŸ¨ Logoè®¾è®¡</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label style="font-weight: 600; color: #374151;">ğŸ’­ æè¿°ä½ çš„éœ€æ±‚</label>
                        <textarea id="message" placeholder="ä¾‹å¦‚ï¼šå¸®æˆ‘åˆ›å»ºä¸€ä¸ªç°ä»£åŒ–çš„ç”µå•†ç½‘ç«™ï¼ŒåŒ…å«å•†å“å±•ç¤ºã€è´­ç‰©è½¦ã€æ”¯ä»˜åŠŸèƒ½..." 
                                style="height: 120px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 15px;">
                        <button class="btn" onclick="sendMessage()" style="flex: 1; padding: 15px; font-size: 1.1rem; background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            ğŸš€ å‘é€æ¶ˆæ¯
                        </button>
                        <button class="btn btn-warning" onclick="clearChat()" style="padding: 15px 20px;">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                    </div>
                    
                    <div class="stats" id="chatStats" style="margin-top: 20px;">
                        <div class="stat-card">
                            <div class="stat-number" id="messageCount">0</div>
                            <div class="stat-label">å¯¹è¯æ¬¡æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avgResponseTime">0ms</div>
                            <div class="stat-label">å“åº”é€Ÿåº¦</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTokens">0</div>
                            <div class="stat-label">Tokenä½¿ç”¨</div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages-area" style="padding: 20px; border-left: 2px solid #f3f4f6;">
                    <h4 style="color: #374151; margin-bottom: 15px;">ğŸ“ å¯¹è¯è®°å½•</h4>
                    <div class="chat-messages" id="chatMessages" style="height: 450px; overflow-y: auto; border: 2px solid #f3f4f6; border-radius: 10px; padding: 15px; background: #fafafa;">
                        <div class="message ai-message">
                            <div class="content" style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #3730a3; padding: 15px; border-radius: 15px; margin-bottom: 10px;">
                                ğŸ‘‹ æ¬¢è¿ä½¿ç”¨JELILIAN AIåŠ©æ‰‹ï¼
                                <br><br>
                                æˆ‘å¯ä»¥å¸®æ‚¨ï¼š
                                <br>â€¢ ğŸŒ åˆ›å»ºå®Œæ•´ç½‘ç«™
                                <br>â€¢ âœï¸ æ’°å†™å„ç±»æ–‡æ¡ˆ
                                <br>â€¢ ğŸ’» ç”Ÿæˆä»£ç ç¨‹åº
                                <br>â€¢ ğŸ“Š åˆ¶ä½œå•†ä¸šæ–‡æ¡£
                                <br><br>
                                è¯·å…ˆé…ç½®APIå¯†é’¥ï¼Œç„¶åå¼€å§‹å¯¹è¯ï¼
                            </div>
                            <div class="message-meta" style="font-size: 0.8rem; color: #9ca3af;">AIåŠ©æ‰‹ â€¢ åˆšåˆš</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è‡ªåŠ¨æ£€æµ‹APIåŸºç¡€URL
        const API_BASE = window.location.origin + '/api';
        let messageCount = 0;
        let totalResponseTime = 0;
        let totalTokens = 0;
        let userSubscription = null;
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·è®¢é˜…
        document.addEventListener('DOMContentLoaded', function() {
            checkUserSubscription();
            // è‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼Œä½†ä¸æ˜¾ç¤ºåŠ è½½ä¿¡æ¯
            checkServerStatus();
        });
        
        async function checkServerStatus() {
            // é™é»˜æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºåŠ è½½ä¿¡æ¯
            try {
                const response = await fetch(`${API_BASE}/providers`);
                if (response.ok) {
                    // æœåŠ¡å™¨æ­£å¸¸ï¼Œä¸éœ€è¦æ˜¾ç¤ºä»»ä½•ä¿¡æ¯
                    console.log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                }
            } catch (error) {
                // æœåŠ¡å™¨å¼‚å¸¸æ—¶æ‰æ˜¾ç¤ºé”™è¯¯
                console.error('âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
            }
        }
        
        async function testConnection() {
            const provider = document.getElementById('provider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('configResult');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: provider,
                        apiKey: apiKey
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼<br>
                            <strong>æœåŠ¡å•†:</strong> ${data.provider}<br>
                            <strong>å“åº”æ—¶é—´:</strong> ${data.responseTime}ms<br>
                            <strong>æµ‹è¯•å“åº”:</strong> ${data.testResponse}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            âŒ è¿æ¥æµ‹è¯•å¤±è´¥<br>
                            <strong>é”™è¯¯:</strong> ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ è¯·æ±‚å¤±è´¥: ${error.message}<br>
                        è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                    </div>
                `;
            }
        }
        
        async function sendMessage() {
            // æ£€æŸ¥ä½¿ç”¨é™åˆ¶
            if (!checkUsageLimit()) {
                return;
            }
            
            const provider = document.getElementById('provider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const message = document.getElementById('message').value.trim();
            const model = document.getElementById('model').value;
            
            if (!apiKey || !message) {
                alert('è¯·è¾“å…¥APIå¯†é’¥å’Œæ¶ˆæ¯å†…å®¹');
                return;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©
            addMessageToChat(message, 'user');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingId = addMessageToChat('æ­£åœ¨æ€è€ƒ...', 'ai', true);
            
            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        provider: provider,
                        apiKey: apiKey,
                        options: {
                            model: model || undefined,
                            maxTokens: 2000,
                            temperature: 0.8
                        }
                    })
                });
                
                const data = await response.json();
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                removeMessage(loadingId);
                
                if (data.success) {
                    // æ·»åŠ AIå“åº”
                    addMessageToChat(data.text, 'ai', false, {
                        responseTime: data.responseTime,
                        tokens: data.tokens,
                        model: data.model
                    });
                    
                    // æ›´æ–°ç»Ÿè®¡
                    updateStats(data.responseTime, data.tokens);
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('message').value = '';
                    
                } else {
                    addMessageToChat(`âŒ é”™è¯¯: ${data.error}`, 'ai');
                }
                
            } catch (error) {
                removeMessage(loadingId);
                addMessageToChat(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'ai');
            }
        }
        
        function addMessageToChat(content, type, isLoading = false, meta = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.id = messageId;
            
            let metaInfo = '';
            if (meta) {
                metaInfo = `<div class="message-meta">
                    å“åº”æ—¶é—´: ${meta.responseTime}ms | 
                    Token: ${meta.tokens} | 
                    æ¨¡å‹: ${meta.model}
                </div>`;
            } else if (type === 'user') {
                metaInfo = `<div class="message-meta">${new Date().toLocaleTimeString()}</div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="content">
                    ${isLoading ? '<span class="loading"></span> ' : ''}${content}
                </div>
                ${metaInfo}
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }
        
        function removeMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
        }
        
        function updateStats(responseTime, tokens) {
            messageCount++;
            totalResponseTime += responseTime;
            totalTokens += tokens;
            
            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('avgResponseTime').textContent = 
                Math.round(totalResponseTime / messageCount) + 'ms';
            document.getElementById('totalTokens').textContent = totalTokens;
        }
        
        function clearChat() {
            document.getElementById('chatMessages').innerHTML = `
                <div class="message ai-message">
                    <div class="content">å¯¹è¯å·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯ã€‚</div>
                    <div class="message-meta">ç³»ç»Ÿæ¶ˆæ¯</div>
                </div>
            `;
            
            // é‡ç½®ç»Ÿè®¡
            messageCount = 0;
            totalResponseTime = 0;
            totalTokens = 0;
            updateStats(0, 0);
        }
        
        async function getProviders() {
            const resultDiv = document.getElementById('configResult');
            
            try {
                const response = await fetch(`${API_BASE}/providers`);
                const data = await response.json();
                
                if (data.success) {
                    const providersList = data.providers.map(p => 
                        `â€¢ <strong>${p.name}</strong>: ${p.description}`
                    ).join('<br>');
                    
                    resultDiv.innerHTML = `
                        <div class="result info">
                            <strong>ğŸ“‹ æ”¯æŒçš„AIæœåŠ¡å•†:</strong><br><br>
                            ${providersList}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ è·å–æœåŠ¡å•†ä¿¡æ¯å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // å¿«æ·é”®æ”¯æŒ
        document.getElementById('message').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // æ£€æŸ¥ç”¨æˆ·è®¢é˜…çŠ¶æ€
        function checkUserSubscription() {
            const subscription = localStorage.getItem('jelilian_subscription');
            const statusDiv = document.getElementById('subscriptionStatus');
            
            if (subscription) {
                const data = JSON.parse(subscription);
                const now = new Date();
                const expires = new Date(data.expires);
                
                if (now < expires) {
                    // æœ‰æ•ˆè®¢é˜…
                    userSubscription = data;
                    statusDiv.innerHTML = `
                        <div class="result success">
                            âœ¨ ${data.plan === 'pro' ? 'ä¸“ä¸šç‰ˆ' : 'ä¼ä¸šç‰ˆ'}ç”¨æˆ· | 
                            åˆ°æœŸ: ${expires.toLocaleDateString()} | 
                            <a href="/payment-system.html" style="color: #065f46;">ç®¡ç†è®¢é˜…</a>
                        </div>
                    `;
                    
                    // å¦‚æœç”¨æˆ·æœ‰è‡ªå®šä¹‰APIå¯†é’¥ï¼Œè‡ªåŠ¨å¡«å…¥
                    if (data.api_key) {
                        document.getElementById('apiKey').value = data.api_key;
                    }
                } else {
                    // è®¢é˜…å·²è¿‡æœŸ
                    statusDiv.innerHTML = `
                        <div class="result warning">
                            âš ï¸ æ‚¨çš„è®¢é˜…å·²è¿‡æœŸï¼Œè¯·ç»­è´¹ä»¥ç»§ç»­ä½¿ç”¨é«˜çº§åŠŸèƒ½
                            <button class="btn" onclick="upgradeToPro()" style="margin-left: 10px;">ç«‹å³ç»­è´¹</button>
                        </div>
                    `;
                }
            } else {
                // å…è´¹ç”¨æˆ·
                statusDiv.innerHTML = `
                    <div class="result info">
                        ğŸ†“ å…è´¹ç”¨æˆ· (æ¯æ—¥é™åˆ¶10æ¬¡å¯¹è¯) | 
                        <a href="/payment-system.html" style="color: #1e40af;">å‡çº§ä¸“ä¸šç‰ˆ</a>
                    `;
            }
        }
        
        // æ£€æŸ¥ä½¿ç”¨é™åˆ¶
        function checkUsageLimit() {
            if (userSubscription && userSubscription.plan !== 'free') {
                return true; // ä»˜è´¹ç”¨æˆ·æ— é™åˆ¶
            }
            
            // å…è´¹ç”¨æˆ·æ£€æŸ¥æ¯æ—¥é™åˆ¶
            const today = new Date().toDateString();
            const usageKey = 'jelilian_daily_usage_' + today;
            const dailyUsage = parseInt(localStorage.getItem(usageKey) || '0');
            
            if (dailyUsage >= 10) {
                alert('æ‚¨ä»Šæ—¥çš„å…è´¹é¢åº¦å·²ç”¨å®Œï¼å‡çº§åˆ°ä¸“ä¸šç‰ˆäº«å—æ— é™åˆ¶ä½¿ç”¨ã€‚');
                upgradeToPro();
                return false;
            }
            
            // å¢åŠ ä½¿ç”¨æ¬¡æ•°
            localStorage.setItem(usageKey, (dailyUsage + 1).toString());
            return true;
        }
        
        function upgradeToPro() {
            window.open('/payment-system.html', '_blank');
        }
        
        function setQuickPrompt(prompt) {
            document.getElementById('message').value = prompt;
            document.getElementById('message').focus();
        }
        
        function showHelp() {
            alert(`ğŸ¤– JELILIAN AIåŠ©æ‰‹ä½¿ç”¨æŒ‡å—ï¼š

1ï¸âƒ£ è·å–APIå¯†é’¥ï¼š
   â€¢ é˜¿é‡Œåƒé—®ï¼šè®¿é—® dashscope.console.aliyun.com
   â€¢ OpenAIï¼šè®¿é—® platform.openai.com

2ï¸âƒ£ é…ç½®å¯†é’¥ï¼š
   â€¢ é€‰æ‹©æœåŠ¡å•†
   â€¢ è¾“å…¥APIå¯†é’¥
   â€¢ ç‚¹å‡»æµ‹è¯•è¿æ¥

3ï¸âƒ£ å¼€å§‹å¯¹è¯ï¼š
   â€¢ æè¿°ä½ çš„éœ€æ±‚
   â€¢ AIä¼šæ™ºèƒ½ç†è§£å¹¶å›å¤
   â€¢ æ”¯æŒç½‘ç«™ã€æ–‡æ¡ˆã€ä»£ç ç­‰

4ï¸âƒ£ å‡çº§ä¸“ä¸šç‰ˆï¼š
   â€¢ å…è´¹ç‰ˆï¼šæ¯æ—¥10æ¬¡å¯¹è¯
   â€¢ ä¸“ä¸šç‰ˆï¼šæ— é™åˆ¶ä½¿ç”¨
   â€¢ ä»…éœ€29å…ƒ/æœˆ

éœ€è¦å¸®åŠ©è¯·è”ç³»å®¢æœï¼`);
        }
        
        function showAPIHelp() {
            const helpContent = `
            <div style="text-align: left;">
                <h3>ğŸ”‘ å¦‚ä½•è·å–APIå¯†é’¥</h3>
                
                <h4>ğŸ‡¨ğŸ‡³ é˜¿é‡Œåƒé—® (æ¨è)</h4>
                <p>1. è®¿é—®ï¼š<a href="https://dashscope.console.aliyun.com" target="_blank">dashscope.console.aliyun.com</a></p>
                <p>2. æ³¨å†Œ/ç™»å½•é˜¿é‡Œäº‘è´¦å·</p>
                <p>3. å¼€é€šDashScopeæœåŠ¡</p>
                <p>4. åˆ›å»ºAPIå¯†é’¥</p>
                <p>5. å¤åˆ¶å¯†é’¥åˆ°è¿™é‡Œä½¿ç”¨</p>
                
                <h4>ğŸŒ OpenAI GPT</h4>
                <p>1. è®¿é—®ï¼š<a href="https://platform.openai.com" target="_blank">platform.openai.com</a></p>
                <p>2. æ³¨å†ŒOpenAIè´¦å·</p>
                <p>3. å……å€¼è´¦æˆ·ä½™é¢</p>
                <p>4. åˆ›å»ºAPIå¯†é’¥</p>
                <p>5. å¤åˆ¶å¯†é’¥åˆ°è¿™é‡Œä½¿ç”¨</p>
                
                <p><strong>ğŸ’¡ æç¤ºï¼š</strong>é˜¿é‡Œåƒé—®å¯¹ä¸­æ–‡æ”¯æŒæ›´å¥½ï¼Œä»·æ ¼æ›´ä¾¿å®œï¼</p>
            </div>
            `;
            
            document.getElementById('configResult').innerHTML = `
                <div class="result info" style="margin-top: 20px;">
                    ${helpContent}
                </div>
            `;
        }
    </script>
</body>
</html>