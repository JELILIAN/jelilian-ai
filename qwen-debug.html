<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå¿«é€Ÿè¯Šæ–­</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .btn { background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; }
        .result { margin-top: 15px; padding: 15px; border-radius: 6px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .warning { background: #fef3c7; color: #92400e; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ APIå¿«é€Ÿè¯Šæ–­å·¥å…·</h1>
        
        <div class="section">
            <h3>ç¯å¢ƒæ£€æŸ¥</h3>
            <button class="btn" onclick="checkEnvironment()">æ£€æŸ¥è¿è¡Œç¯å¢ƒ</button>
            <div id="envResult"></div>
        </div>
        
        <div class="section">
            <h3>ç½‘ç»œè¿æ¥æµ‹è¯•</h3>
            <button class="btn" onclick="testNetwork()">æµ‹è¯•ç½‘ç»œ</button>
            <div id="networkResult"></div>
        </div>
        
        <div class="section">
            <h3>APIå¯†é’¥æµ‹è¯•</h3>
            <input type="password" id="testApiKey" placeholder="è¾“å…¥APIå¯†é’¥">
            <button class="btn" onclick="testApiKey()">æµ‹è¯•å¯†é’¥</button>
            <div id="keyResult"></div>
        </div>
        
        <div class="section">
            <h3>å®Œæ•´APIè°ƒç”¨æµ‹è¯•</h3>
            <textarea id="testMsg" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯">ä½ å¥½</textarea>
            <button class="btn" onclick="fullApiTest()">å®Œæ•´æµ‹è¯•</button>
            <div id="fullResult"></div>
        </div>
        
        <div class="section">
            <h3>é”™è¯¯æ—¥å¿—</h3>
            <div id="errorLog" style="background: #f8fafc; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;"></div>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        let errorLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            errorLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateErrorLog();
            console.log(`[${type}]`, message);
        }
        
        function updateErrorLog() {
            document.getElementById('errorLog').innerHTML = errorLog.join('<br>');
        }
        
        function clearLog() {
            errorLog = [];
            updateErrorLog();
        }
        
        function checkEnvironment() {
            const result = document.getElementById('envResult');
            log('å¼€å§‹ç¯å¢ƒæ£€æŸ¥');
            
            const checks = [];
            
            // æ£€æŸ¥åè®®
            if (location.protocol === 'file:') {
                checks.push('âŒ è¿è¡Œåœ¨file://åè®®ä¸‹ï¼Œå¯èƒ½å¯¼è‡´CORSé—®é¢˜');
                log('æ£€æµ‹åˆ°file://åè®®', 'warning');
            } else {
                checks.push('âœ… è¿è¡Œåœ¨HTTP/HTTPSåè®®ä¸‹');
                log('åè®®æ£€æŸ¥é€šè¿‡', 'success');
            }
            
            // æ£€æŸ¥æµè§ˆå™¨
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) {
                checks.push('âœ… Chromeæµè§ˆå™¨');
            } else if (userAgent.includes('Firefox')) {
                checks.push('âœ… Firefoxæµè§ˆå™¨');
            } else {
                checks.push('âš ï¸ å…¶ä»–æµè§ˆå™¨ï¼Œå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜');
            }
            
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (navigator.onLine) {
                checks.push('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸');
            } else {
                checks.push('âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸');
            }
            
            // æ£€æŸ¥HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                checks.push('âœ… å®‰å…¨è¿æ¥');
            } else {
                checks.push('âš ï¸ éHTTPSè¿æ¥ï¼ŒæŸäº›APIå¯èƒ½å—é™');
            }
            
            result.innerHTML = `<div class="result ${checks.some(c => c.includes('âŒ')) ? 'error' : 'success'}">
                ${checks.join('<br>')}
            </div>`;
        }
        
        async function testNetwork() {
            const result = document.getElementById('networkResult');
            log('å¼€å§‹ç½‘ç»œæµ‹è¯•');
            
            result.innerHTML = '<div class="result warning">ğŸ”„ æµ‹è¯•ç½‘ç»œè¿æ¥...</div>';
            
            try {
                // æµ‹è¯•åŸºæœ¬ç½‘ç»œè¿æ¥
                const response = await fetch('https://httpbin.org/get', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    log('åŸºæœ¬ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
                    
                    // æµ‹è¯•é˜¿é‡Œäº‘è¿æ¥
                    try {
                        await fetch('https://dashscope.aliyuncs.com', {
                            method: 'HEAD',
                            mode: 'no-cors'
                        });
                        log('é˜¿é‡Œäº‘APIç«¯ç‚¹å¯è®¿é—®', 'success');
                        result.innerHTML = '<div class="result success">âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå¯ä»¥è®¿é—®é˜¿é‡Œäº‘API</div>';
                    } catch (error) {
                        log(`é˜¿é‡Œäº‘è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                        result.innerHTML = '<div class="result warning">âš ï¸ åŸºæœ¬ç½‘ç»œæ­£å¸¸ï¼Œä½†é˜¿é‡Œäº‘APIè®¿é—®å¯èƒ½å—é™</div>';
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`ç½‘ç»œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                result.innerHTML = '<div class="result error">âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸: ' + error.message + '</div>';
            }
        }
        
        async function testApiKey() {
            const apiKey = document.getElementById('testApiKey').value.trim();
            const result = document.getElementById('keyResult');
            
            if (!apiKey) {
                result.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥</div>';
                return;
            }
            
            log('å¼€å§‹APIå¯†é’¥æµ‹è¯•');
            result.innerHTML = '<div class="result warning">ğŸ”„ éªŒè¯APIå¯†é’¥...</div>';
            
            // æ ¼å¼æ£€æŸ¥
            if (!apiKey.startsWith('sk-')) {
                log('APIå¯†é’¥æ ¼å¼é”™è¯¯', 'error');
                result.innerHTML = '<div class="result error">âŒ APIå¯†é’¥æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥ä»¥"sk-"å¼€å¤´</div>';
                return;
            }
            
            if (apiKey.length < 20) {
                log('APIå¯†é’¥é•¿åº¦å¯èƒ½ä¸æ­£ç¡®', 'warning');
                result.innerHTML = '<div class="result warning">âš ï¸ APIå¯†é’¥é•¿åº¦ä¼¼ä¹ä¸æ­£ç¡®</div>';
                return;
            }
            
            log('APIå¯†é’¥æ ¼å¼æ£€æŸ¥é€šè¿‡', 'success');
            result.innerHTML = '<div class="result success">âœ… APIå¯†é’¥æ ¼å¼æ­£ç¡®</div>';
        }
        
        async function fullApiTest() {
            const apiKey = document.getElementById('testApiKey').value.trim();
            const message = document.getElementById('testMsg').value.trim();
            const result = document.getElementById('fullResult');
            
            if (!apiKey || !message) {
                result.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥å’Œæµ‹è¯•æ¶ˆæ¯</div>';
                return;
            }
            
            log('å¼€å§‹å®Œæ•´APIæµ‹è¯•');
            result.innerHTML = '<div class="result warning">ğŸ”„ æ­£åœ¨è°ƒç”¨API...</div>';
            
            try {
                const requestBody = {
                    model: 'qwen-turbo',
                    input: {
                        messages: [
                            {
                                role: 'user',
                                content: message
                            }
                        ]
                    },
                    parameters: {
                        result_format: 'message',
                        max_tokens: 500,
                        temperature: 0.8
                    }
                };
                
                log(`è¯·æ±‚ä½“: ${JSON.stringify(requestBody, null, 2)}`);
                
                const startTime = Date.now();
                const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'X-DashScope-SSE': 'disable'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                log(`å“åº”æ—¶é—´: ${responseTime}ms`);
                
                const responseText = await response.text();
                log(`åŸå§‹å“åº”: ${responseText}`);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`JSONè§£æå¤±è´¥: ${parseError.message}`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.message || response.statusText}`);
                }
                
                if (data.code && data.code !== '200') {
                    throw new Error(`APIé”™è¯¯ ${data.code}: ${data.message}`);
                }
                
                if (!data.output || !data.output.choices || !data.output.choices[0]) {
                    throw new Error('APIå“åº”æ ¼å¼é”™è¯¯');
                }
                
                const aiResponse = data.output.choices[0].message.content;
                const tokens = data.usage ? data.usage.total_tokens : 0;
                
                log('APIè°ƒç”¨æˆåŠŸ', 'success');
                
                result.innerHTML = `
                    <div class="result success">
                        <strong>âœ… APIè°ƒç”¨æˆåŠŸï¼</strong><br>
                        <strong>å“åº”æ—¶é—´:</strong> ${responseTime}ms<br>
                        <strong>ä½¿ç”¨Token:</strong> ${tokens}<br>
                        <strong>æ¨¡å‹:</strong> qwen-turbo<br><br>
                        <strong>AIå›å¤:</strong><br>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #10b981;">
                            ${aiResponse}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                log(`APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                
                let errorHtml = `<div class="result error"><strong>âŒ APIè°ƒç”¨å¤±è´¥</strong><br>`;
                errorHtml += `<strong>é”™è¯¯:</strong> ${error.message}<br><br>`;
                
                // æä¾›å…·ä½“çš„è§£å†³å»ºè®®
                if (error.message.includes('CORS')) {
                    errorHtml += `<strong>è§£å†³æ–¹æ¡ˆ:</strong> CORSè·¨åŸŸé—®é¢˜<br>`;
                    errorHtml += `1. ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨: <code>python -m http.server 8000</code><br>`;
                    errorHtml += `2. æˆ–ä½¿ç”¨ä»£ç†æœåŠ¡å™¨<br>`;
                } else if (error.message.includes('401')) {
                    errorHtml += `<strong>è§£å†³æ–¹æ¡ˆ:</strong> APIå¯†é’¥é—®é¢˜<br>`;
                    errorHtml += `1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®<br>`;
                    errorHtml += `2. ç¡®è®¤å¯†é’¥å·²æ¿€æ´»<br>`;
                } else if (error.message.includes('403')) {
                    errorHtml += `<strong>è§£å†³æ–¹æ¡ˆ:</strong> æƒé™é—®é¢˜<br>`;
                    errorHtml += `1. æ£€æŸ¥è´¦æˆ·ä½™é¢<br>`;
                    errorHtml += `2. ç¡®è®¤APIæƒé™è®¾ç½®<br>`;
                } else if (error.message.includes('429')) {
                    errorHtml += `<strong>è§£å†³æ–¹æ¡ˆ:</strong> è¯·æ±‚é¢‘ç‡é™åˆ¶<br>`;
                    errorHtml += `1. é™ä½è¯·æ±‚é¢‘ç‡<br>`;
                    errorHtml += `2. ç¨åé‡è¯•<br>`;
                } else if (error.message.includes('ç½‘ç»œ')) {
                    errorHtml += `<strong>è§£å†³æ–¹æ¡ˆ:</strong> ç½‘ç»œè¿æ¥é—®é¢˜<br>`;
                    errorHtml += `1. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>`;
                    errorHtml += `2. å°è¯•ä½¿ç”¨VPN<br>`;
                }
                
                errorHtml += `</div>`;
                result.innerHTML = errorHtml;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', function() {
            checkEnvironment();
        });
        
        // æ•è·å…¨å±€é”™è¯¯
        window.addEventListener('error', function(event) {
            log(`å…¨å±€é”™è¯¯: ${event.error.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            log(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>PE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿é‡Œåƒé—®APIè°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: system-ui; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #ff6b35; margin-bottom: 10px; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .section h3 { color: #1f2937; margin-bottom: 15px; }
        .input-group { margin: 15px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; }
        .input-group textarea { height: 100px; resize: vertical; }
        .btn { background: #ff6b35; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; margin: 5px; }
        .btn:hover { background: #e55a2b; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .result { margin-top: 20px; padding: 15px; border-radius: 6px; }
        .success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .warning { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
        .code { background: #f3f4f6; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; overflow-x: auto; margin: 10px 0; }
        .step { margin: 10px 0; padding: 10px; background: #f8fafc; border-left: 4px solid #6366f1; }
        .step-title { font-weight: 600; color: #1e293b; }
        .step-desc { color: #64748b; font-size: 14px; margin-top: 5px; }
        .progress { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: #ff6b35; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ é˜¿é‡Œåƒé—®APIè°ƒè¯•å·¥å…·</h1>
            <p>è¯Šæ–­å’Œä¿®å¤é˜¿é‡Œåƒé—®APIè°ƒç”¨é—®é¢˜</p>
        </div>
        
        <div class="section">
            <h3>ğŸ“‹ APIé…ç½®æ£€æŸ¥</h3>
            <div class="input-group">
                <label>APIå¯†é’¥ (sk-å¼€å¤´)</label>
                <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„é˜¿é‡Œåƒé—®APIå¯†é’¥">
            </div>
            <div class="input-group">
                <label>æ¨¡å‹é€‰æ‹©</label>
                <select id="modelSelect">
                    <option value="qwen-turbo">qwen-turbo (æ¨è)</option>
                    <option value="qwen-plus">qwen-plus</option>
                    <option value="qwen-max">qwen-max</option>
                    <option value="qwen-max-1201">qwen-max-1201</option>
                </select>
            </div>
            <button class="btn" onclick="validateConfig()">éªŒè¯é…ç½®</button>
            <div id="configResult"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ” è¿æ¥è¯Šæ–­</h3>
            <div id="diagnosticSteps">
                <div class="step">
                    <div class="step-title">æ­¥éª¤1: æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
                    <div class="step-desc">æµ‹è¯•æ˜¯å¦èƒ½è®¿é—®é˜¿é‡Œäº‘APIç«¯ç‚¹</div>
                </div>
                <div class="step">
                    <div class="step-title">æ­¥éª¤2: éªŒè¯APIå¯†é’¥æ ¼å¼</div>
                    <div class="step-desc">æ£€æŸ¥APIå¯†é’¥æ˜¯å¦ç¬¦åˆæ­£ç¡®æ ¼å¼</div>
                </div>
                <div class="step">
                    <div class="step-title">æ­¥éª¤3: æµ‹è¯•APIè°ƒç”¨</div>
                    <div class="step-desc">å‘é€æµ‹è¯•è¯·æ±‚åˆ°åƒé—®API</div>
                </div>
                <div class="step">
                    <div class="step-title">æ­¥éª¤4: è§£æå“åº”æ•°æ®</div>
                    <div class="step-desc">æ£€æŸ¥APIå“åº”æ ¼å¼æ˜¯å¦æ­£ç¡®</div>
                </div>
            </div>
            <button class="btn" onclick="runDiagnostic()">å¼€å§‹è¯Šæ–­</button>
            <div class="progress" id="diagnosticProgress" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="diagnosticResult"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ’¬ APIæµ‹è¯•</h3>
            <div class="input-group">
                <label>æµ‹è¯•æ¶ˆæ¯</label>
                <textarea id="testMessage" placeholder="è¾“å…¥è¦å‘é€ç»™åƒé—®çš„æµ‹è¯•æ¶ˆæ¯...">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±</textarea>
            </div>
            <button class="btn" onclick="testAPI()">å‘é€æµ‹è¯•</button>
            <button class="btn btn-secondary" onclick="testMultipleMessages()">æ‰¹é‡æµ‹è¯•</button>
            <div id="testResult"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ› ï¸ å¸¸è§é—®é¢˜ä¿®å¤</h3>
            <div class="step">
                <div class="step-title">é—®é¢˜1: CORSè·¨åŸŸé”™è¯¯</div>
                <div class="step-desc">
                    <strong>è§£å†³æ–¹æ¡ˆ:</strong> åœ¨æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒä¸­è¿è¡Œï¼Œæˆ–ä½¿ç”¨ä»£ç†æœåŠ¡å™¨
                    <div class="code">
                        # ä½¿ç”¨Pythonå¯åŠ¨æœ¬åœ°æœåŠ¡å™¨<br>
                        python -m http.server 8000<br><br>
                        # æˆ–ä½¿ç”¨Node.js<br>
                        npx serve .
                    </div>
                </div>
            </div>
            <div class="step">
                <div class="step-title">é—®é¢˜2: APIå¯†é’¥æ— æ•ˆ</div>
                <div class="step-desc">
                    <strong>è§£å†³æ–¹æ¡ˆ:</strong> æ£€æŸ¥APIå¯†é’¥æ ¼å¼å’Œæƒé™
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>ç¡®ä¿APIå¯†é’¥ä»¥ "sk-" å¼€å¤´</li>
                        <li>æ£€æŸ¥å¯†é’¥æ˜¯å¦å·²æ¿€æ´»</li>
                        <li>ç¡®è®¤è´¦æˆ·ä½™é¢å……è¶³</li>
                        <li>éªŒè¯APIæƒé™è®¾ç½®</li>
                    </ul>
                </div>
            </div>
            <div class="step">
                <div class="step-title">é—®é¢˜3: è¯·æ±‚æ ¼å¼é”™è¯¯</div>
                <div class="step-desc">
                    <strong>è§£å†³æ–¹æ¡ˆ:</strong> ä½¿ç”¨æ­£ç¡®çš„è¯·æ±‚æ ¼å¼
                    <div class="code" id="correctFormat"></div>
                </div>
            </div>
            <button class="btn" onclick="showCorrectFormat()">æ˜¾ç¤ºæ­£ç¡®æ ¼å¼</button>
            <button class="btn btn-secondary" onclick="fixCommonIssues()">è‡ªåŠ¨ä¿®å¤</button>
        </div>
        
        <div class="section">
            <h3>ğŸ“Š APIä½¿ç”¨ç»Ÿè®¡</h3>
            <div id="apiStats">
                <p>è¯·å…ˆè¿›è¡ŒAPIæµ‹è¯•ä»¥æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</p>
            </div>
        </div>
    </div>

    <script>
        let testCount = 0;
        let successCount = 0;
        let errorCount = 0;
        
        function validateConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('configResult');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥</div>';
                return false;
            }
            
            // æ£€æŸ¥APIå¯†é’¥æ ¼å¼
            if (!apiKey.startsWith('sk-')) {
                resultDiv.innerHTML = '<div class="result warning">âš ï¸ APIå¯†é’¥æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥"sk-"å¼€å¤´</div>';
                return false;
            }
            
            if (apiKey.length < 20) {
                resultDiv.innerHTML = '<div class="result warning">âš ï¸ APIå¯†é’¥é•¿åº¦ä¼¼ä¹ä¸æ­£ç¡®</div>';
                return false;
            }
            
            resultDiv.innerHTML = '<div class="result success">âœ… APIå¯†é’¥æ ¼å¼éªŒè¯é€šè¿‡</div>';
            return true;
        }
        
        async function runDiagnostic() {
            if (!validateConfig()) return;
            
            const progressDiv = document.getElementById('diagnosticProgress');
            const progressBar = document.getElementById('progressBar');
            const resultDiv = document.getElementById('diagnosticResult');
            
            progressDiv.style.display = 'block';
            resultDiv.innerHTML = '';
            
            const steps = [
                { name: 'æ£€æŸ¥ç½‘ç»œè¿æ¥', func: checkNetwork },
                { name: 'éªŒè¯APIå¯†é’¥', func: validateApiKey },
                { name: 'æµ‹è¯•APIè°ƒç”¨', func: testApiCall },
                { name: 'è§£æå“åº”æ•°æ®', func: parseResponse }
            ];
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                progressBar.style.width = `${(i / steps.length) * 100}%`;
                
                resultDiv.innerHTML += `<div class="result info">ğŸ”„ ${step.name}...</div>`;
                
                try {
                    const result = await step.func();
                    resultDiv.innerHTML += `<div class="result success">âœ… ${step.name}: ${result}</div>`;
                } catch (error) {
                    resultDiv.innerHTML += `<div class="result error">âŒ ${step.name}: ${error.message}</div>`;
                    break;
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            progressBar.style.width = '100%';
        }
        
        async function checkNetwork() {
            try {
                const response = await fetch('https://dashscope.aliyuncs.com', { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                return 'ç½‘ç»œè¿æ¥æ­£å¸¸';
            } catch (error) {
                throw new Error('æ— æ³•è¿æ¥åˆ°é˜¿é‡Œäº‘APIæœåŠ¡å™¨');
            }
        }
        
        async function validateApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey.startsWith('sk-') && apiKey.length > 20) {
                return 'APIå¯†é’¥æ ¼å¼æ­£ç¡®';
            }
            throw new Error('APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®');
        }
        
        async function testApiCall() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelSelect').value;
            
            const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'X-DashScope-SSE': 'disable'
                },
                body: JSON.stringify({
                    model: model,
                    input: {
                        messages: [
                            {
                                role: 'user',
                                content: 'Hello'
                            }
                        ]
                    },
                    parameters: {
                        result_format: 'message',
                        max_tokens: 100
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return 'APIè°ƒç”¨æˆåŠŸ';
        }
        
        async function parseResponse() {
            return 'å“åº”è§£ææ­£å¸¸';
        }
        
        async function testAPI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelSelect').value;
            const message = document.getElementById('testMessage').value.trim();
            const resultDiv = document.getElementById('testResult');
            
            if (!apiKey || !message) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·è¾“å…¥APIå¯†é’¥å’Œæµ‹è¯•æ¶ˆæ¯</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result info">ğŸ”„ æ­£åœ¨å‘é€è¯·æ±‚...</div>';
            testCount++;
            
            try {
                const startTime = Date.now();
                
                const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'X-DashScope-SSE': 'disable'
                    },
                    body: JSON.stringify({
                        model: model,
                        input: {
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯JELILIAN AIåŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡å›å¤ã€‚'
                                },
                                {
                                    role: 'user',
                                    content: message
                                }
                            ]
                        },
                        parameters: {
                            result_format: 'message',
                            max_tokens: 1500,
                            temperature: 0.8
                        }
                    })
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.message || response.statusText}`);
                }
                
                if (data.code && data.code !== '200') {
                    throw new Error(`APIé”™è¯¯ ${data.code}: ${data.message}`);
                }
                
                if (!data.output || !data.output.choices || !data.output.choices[0]) {
                    throw new Error('APIå“åº”æ ¼å¼é”™è¯¯');
                }
                
                successCount++;
                const aiResponse = data.output.choices[0].message.content;
                const tokens = data.usage ? data.usage.total_tokens : 0;
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        <strong>âœ… APIè°ƒç”¨æˆåŠŸï¼</strong><br>
                        <strong>å“åº”æ—¶é—´:</strong> ${responseTime}ms<br>
                        <strong>ä½¿ç”¨Token:</strong> ${tokens}<br>
                        <strong>æ¨¡å‹:</strong> ${model}<br><br>
                        <strong>AIå›å¤:</strong><br>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            ${aiResponse}
                        </div>
                    </div>
                `;
                
                updateStats();
                
            } catch (error) {
                errorCount++;
                console.error('API Test Error:', error);
                
                let errorMessage = error.message;
                let suggestion = '';
                
                if (error.message.includes('401')) {
                    suggestion = 'å»ºè®®: æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®';
                } else if (error.message.includes('403')) {
                    suggestion = 'å»ºè®®: æ£€æŸ¥APIæƒé™å’Œè´¦æˆ·ä½™é¢';
                } else if (error.message.includes('429')) {
                    suggestion = 'å»ºè®®: é™ä½è¯·æ±‚é¢‘ç‡ï¼Œç¨åé‡è¯•';
                } else if (error.message.includes('CORS')) {
                    suggestion = 'å»ºè®®: åœ¨æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒä¸­è¿è¡Œ';
                }
                
                resultDiv.innerHTML = `
                    <div class="result error">
                        <strong>âŒ APIè°ƒç”¨å¤±è´¥</strong><br>
                        <strong>é”™è¯¯ä¿¡æ¯:</strong> ${errorMessage}<br>
                        ${suggestion ? `<strong>è§£å†³å»ºè®®:</strong> ${suggestion}` : ''}
                    </div>
                `;
                
                updateStats();
            }
        }
        
        async function testMultipleMessages() {
            const messages = [
                'ä½ å¥½',
                'è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±',
                'å¸®æˆ‘å†™ä¸€ä¸ªç®€å•çš„ç½‘é¡µ',
                'ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ'
            ];
            
            for (const msg of messages) {
                document.getElementById('testMessage').value = msg;
                await testAPI();
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
        
        function showCorrectFormat() {
            const format = `{
  "model": "qwen-turbo",
  "input": {
    "messages": [
      {
        "role": "system",
        "content": "ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹"
      },
      {
        "role": "user", 
        "content": "ç”¨æˆ·æ¶ˆæ¯"
      }
    ]
  },
  "parameters": {
    "result_format": "message",
    "max_tokens": 1500,
    "temperature": 0.8
  }
}`;
            
            document.getElementById('correctFormat').innerHTML = format;
        }
        
        function fixCommonIssues() {
            // è‡ªåŠ¨ä¿®å¤ä¸€äº›å¸¸è§é—®é¢˜
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey.startsWith('sk-')) {
                alert('è¯·ç¡®ä¿APIå¯†é’¥ä»¥"sk-"å¼€å¤´');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒ
            if (location.protocol === 'file:') {
                alert('æ£€æµ‹åˆ°æ‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç¯å¢ƒä¸­è¿è¡Œã€‚å»ºè®®ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨:\n\npython -m http.server 8000\næˆ–\nnpx serve .');
                return;
            }
            
            alert('âœ… å¸¸è§é—®é¢˜æ£€æŸ¥å®Œæˆï¼å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯ã€‚');
        }
        
        function updateStats() {
            const statsDiv = document.getElementById('apiStats');
            const successRate = testCount > 0 ? ((successCount / testCount) * 100).toFixed(1) : 0;
            
            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #0369a1;">${testCount}</div>
                        <div style="color: #0369a1;">æ€»æµ‹è¯•æ¬¡æ•°</div>
                    </div>
                    <div style="background: #d1fae5; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #065f46;">${successCount}</div>
                        <div style="color: #065f46;">æˆåŠŸæ¬¡æ•°</div>
                    </div>
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #991b1b;">${errorCount}</div>
                        <div style="color: #991b1b;">å¤±è´¥æ¬¡æ•°</div>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #92400e;">${successRate}%</div>
                        <div style="color: #92400e;">æˆåŠŸç‡</div>
                    </div>
                </div>
            `;
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ­£ç¡®æ ¼å¼
        document.addEventListener('DOMContentLoaded', function() {
            showCorrectFormat();
        });
    </script>
</body>
</html>